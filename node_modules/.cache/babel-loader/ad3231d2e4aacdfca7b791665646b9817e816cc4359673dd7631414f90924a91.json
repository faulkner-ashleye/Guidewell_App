{"ast":null,"code":"import{useEffect,useState,useCallback,useRef}from'react';import{usePlaidLinkSingleton}from'../hooks/usePlaidLinkSingleton';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";export default function PlaidLinkButton(_ref){let{userId='demo-user-123',onSuccess,apiBase='http://localhost:3001'}=_ref;const[linkToken,setLinkToken]=useState(null);const[error,setError]=useState(null);const[isInitialized,setIsInitialized]=useState(false);const isInitializing=useRef(false);const handleSuccess=useCallback(async public_token=>{try{// Exchange public_token -> access_token (server-side)\nawait fetch(\"\".concat(apiBase,\"/plaid/item/public_token/exchange\"),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({public_token,userId})});// Fetch mapped accounts\nconst r=await fetch(\"\".concat(apiBase,\"/plaid/accounts?userId=\").concat(encodeURIComponent(userId)));const{accounts}=await r.json();onSuccess(accounts);}catch(e){setError('Link success, but account fetch failed');}},[apiBase,userId,onSuccess]);useEffect(()=>{let isMounted=true;let timeoutId;// Prevent multiple simultaneous initializations\nif(isInitializing.current){return;}isInitializing.current=true;// Debounce the request to prevent multiple rapid calls\ntimeoutId=setTimeout(async()=>{try{console.log('Fetching link token from:',\"\".concat(apiBase,\"/plaid/link/token/create\"));console.log('Current window location:',window.location.href);console.log('Request body:',JSON.stringify({userId}));const r=await fetch(\"\".concat(apiBase,\"/plaid/link/token/create\"),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId})});console.log('Response status:',r.status);console.log('Response headers:',Object.fromEntries(r.headers.entries()));if(!r.ok){throw new Error(\"HTTP \".concat(r.status,\": \").concat(r.statusText));}const data=await r.json();console.log('Received link token:',data);if(isMounted){setLinkToken(data.link_token);setIsInitialized(true);}}catch(e){console.error('Plaid Link initialization error:',e);if(isMounted){setError(\"Failed to init Plaid Link: \".concat(e.message));}}finally{isInitializing.current=false;}},500);// 500ms debounce\nreturn()=>{isMounted=false;clearTimeout(timeoutId);};},[userId,apiBase]);const config={token:linkToken||'',onSuccess:handleSuccess,onExit:()=>{}};const{open,ready,error:plaidError}=usePlaidLinkSingleton(config);if(error)return/*#__PURE__*/_jsx(\"div\",{children:error});if(plaidError)return/*#__PURE__*/_jsxs(\"div\",{children:[\"Plaid Error: \",plaidError]});if(!isInitialized||!linkToken)return/*#__PURE__*/_jsx(\"button\",{disabled:true,children:\"Plaid unavailable\"});return/*#__PURE__*/_jsx(\"button\",{onClick:()=>open(),disabled:!ready,children:\"Connect with Plaid\"});}","map":{"version":3,"names":["useEffect","useState","useCallback","useRef","usePlaidLinkSingleton","jsx","_jsx","jsxs","_jsxs","PlaidLinkButton","_ref","userId","onSuccess","apiBase","linkToken","setLinkToken","error","setError","isInitialized","setIsInitialized","isInitializing","handleSuccess","public_token","fetch","concat","method","headers","body","JSON","stringify","r","encodeURIComponent","accounts","json","e","isMounted","timeoutId","current","setTimeout","console","log","window","location","href","status","Object","fromEntries","entries","ok","Error","statusText","data","link_token","message","clearTimeout","config","token","onExit","open","ready","plaidError","children","disabled","onClick"],"sources":["C:/Users/aefau/Documents/Become an AI Product Designer/Guidewell/src/components/PlaidLinkButton.tsx"],"sourcesContent":["import { useEffect, useState, useCallback, useRef } from 'react';\nimport { PlaidLinkOptions } from 'react-plaid-link';\nimport { usePlaidLinkSingleton } from '../hooks/usePlaidLinkSingleton';\n\ntype Props = {\n  userId?: string;\n  onSuccess: (mappedAccounts: any[]) => void;\n  apiBase?: string; // default http://localhost:3001\n};\n\nexport default function PlaidLinkButton({ userId = 'demo-user-123', onSuccess, apiBase = 'http://localhost:3001' }: Props) {\n  const [linkToken, setLinkToken] = useState<string | null>(null);\n  const [error, setError] = useState<string | null>(null);\n  const [isInitialized, setIsInitialized] = useState(false);\n  const isInitializing = useRef(false);\n\n  const handleSuccess = useCallback(async (public_token: string) => {\n    try {\n      // Exchange public_token -> access_token (server-side)\n      await fetch(`${apiBase}/plaid/item/public_token/exchange`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ public_token, userId }),\n      });\n      // Fetch mapped accounts\n      const r = await fetch(`${apiBase}/plaid/accounts?userId=${encodeURIComponent(userId)}`);\n      const { accounts } = await r.json();\n      onSuccess(accounts);\n    } catch (e) {\n      setError('Link success, but account fetch failed');\n    }\n  }, [apiBase, userId, onSuccess]);\n\n  useEffect(() => {\n    let isMounted = true;\n    let timeoutId: NodeJS.Timeout;\n    \n    // Prevent multiple simultaneous initializations\n    if (isInitializing.current) {\n      return;\n    }\n    \n    isInitializing.current = true;\n    \n    // Debounce the request to prevent multiple rapid calls\n    timeoutId = setTimeout(async () => {\n      try {\n        console.log('Fetching link token from:', `${apiBase}/plaid/link/token/create`);\n        console.log('Current window location:', window.location.href);\n        console.log('Request body:', JSON.stringify({ userId }));\n        \n        const r = await fetch(`${apiBase}/plaid/link/token/create`, {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({ userId }),\n        });\n        \n        console.log('Response status:', r.status);\n        console.log('Response headers:', Object.fromEntries(r.headers.entries()));\n        \n        if (!r.ok) {\n          throw new Error(`HTTP ${r.status}: ${r.statusText}`);\n        }\n        \n        const data = await r.json();\n        console.log('Received link token:', data);\n        \n        if (isMounted) {\n          setLinkToken(data.link_token);\n          setIsInitialized(true);\n        }\n      } catch (e: any) {\n        console.error('Plaid Link initialization error:', e);\n        if (isMounted) {\n          setError(`Failed to init Plaid Link: ${e.message}`);\n        }\n      } finally {\n        isInitializing.current = false;\n      }\n    }, 500); // 500ms debounce\n\n    return () => {\n      isMounted = false;\n      clearTimeout(timeoutId);\n    };\n  }, [userId, apiBase]);\n\n  const config: PlaidLinkOptions = {\n    token: linkToken || '',\n    onSuccess: handleSuccess,\n    onExit: () => {},\n  };\n\n  const { open, ready, error: plaidError } = usePlaidLinkSingleton(config);\n\n  if (error) return <div>{error}</div>;\n  if (plaidError) return <div>Plaid Error: {plaidError}</div>;\n  if (!isInitialized || !linkToken) return <button disabled>Plaid unavailable</button>;\n\n  \n  return (\n    <button onClick={() => open()} disabled={!ready}>\n      Connect with Plaid\n    </button>\n  );\n}"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}